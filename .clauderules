# 存储过程迁移开发规则

## TDD 开发流程

当开发或修复存储过程迁移功能时，必须遵循以下 TDD 流程：

### 1. 红色阶段 - 编写失败的测试
```bash
# 运行测试确认失败
dotnet test --filter "FullyQualifiedName~TestMethodName"
```

### 2. 绿色阶段 - 实现最小代码使测试通过
- 修改 `ScriptGenerator` 或 `Migration` 中的代码
- 仅编写足够使测试通过的代码

### 3. 重构阶段 - 优化代码
- 提取共性，优化结构
- 确保测试仍然通过

### 4. 循环
- 重复上述过程，逐步完善功能

## 错误分析和调试流程

### 步骤 1：运行迁移并查看日志

1. 运行 WPF 应用程序执行迁移
2. 日志文件位置：应用程序目录下的 `logs/` 文件夹
3. 找到最新的日志文件（按时间戳命名）

### 步骤 2：分析错误

日志会记录：
- 语法解析错误（ParseError）
- PostgreSQL 执行错误（PostgresException with SqlState）
- 转换后的 SQL（用于调试）

常见错误类型：
- **42P01**: 表不存在
- **42703**: 列不存在
- **42601**: 语法错误
- **22004**: NULL 值错误

### 步骤 3：为错误场景编写测试

根据日志中的错误，在 `DatabaseMigrationTest` 项目中编写单元测试：

```csharp
[Theory]
[InlineData(@"-- 原始 T-SQL", @"-- 期望的 PostgreSQL SQL")]
public void Test_SpecificScenario(string tsql, string expectedPostgresSql)
{
    var fragment = tsql.ParseToFragment();
    var generator = new PostgreSqlProcedureScriptGenerator();
    var result = generator.GenerateSqlScript(fragment);
    Assert.Equal(expectedPostgresSql, result);
}
```

### 步骤 4：运行测试确认失败

```bash
dotnet test --filter "FullyQualifiedName~Test_SpecificScenario"
```

### 步骤 5：实现修复

- 修改 `PostgreSqlScriptGenerator` 或其子类
- 运行测试确认通过

### 步骤 6：验证完整迁移

```bash
# 运行所有测试
dotnet test

# 然后运行 WPF 应用验证完整迁移
```

## 测试文件组织

- `TSqlFragmentExtension_*.cs`: 测试 T-SQL 片段的解析和提取
- `PostgreSqlScriptGenerator_*_Tests.cs`: 测试特定 SQL 语句的转换
- 按功能组织测试文件，如：
  - `PostgreSqlScriptGenerator_Declare_Tests.cs` - DECLARE 语句
  - `PostgreSqlScriptGenerator_IfBlock_Tests.cs` - IF 语句块
  - `PostgreSqlScriptGenerator_Select_Tests.cs` - SELECT 语句

## 日志文件格式

```
[时间] [级别] 消息内容
```

关键日志级别：
- `Log`: 正常信息
- `LogError`: 错误信息（包含错误详情和转换后的 SQL）

## 禁止行为

1. ❌ 不编写测试直接修改代码
2. ❌ 忽略测试失败继续开发
3. ❌ 不查看日志直接猜测问题
4. ❌ 一次性修改大量功能

## 推荐工作流

```bash
# 1. 运行应用，触发错误
# 2. 查看日志，找到失败的 SQL
# 3. 为该 SQL 编写测试（预期会失败）
dotnet test --filter "FullyQualifiedName~NewTest"

# 4. 实现修复
# 5. 运行测试确认通过
dotnet test --filter "FullyQualifiedName~NewTest"

# 6. 运行所有测试确保没有回归
dotnet test

# 7. 重新运行完整迁移验证
```
